# Prometheus Alert Rules for CivicQ
# Defines critical and warning alerts for production monitoring

groups:
  # ============================================================================
  # CRITICAL ALERTS - Require immediate attention
  # ============================================================================

  - name: critical_alerts
    interval: 30s
    rules:
      # Service down
      - alert: ServiceDown
        expr: up{job="civicq-api"} == 0
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "CivicQ API is down"
          description: "The CivicQ API has been down for more than 2 minutes on instance {{ $labels.instance }}"

      # High error rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(civicq_http_requests_total{status=~"5.."}[5m])) by (job)
            /
            sum(rate(civicq_http_requests_total[5m])) by (job)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%) for {{ $labels.job }}"

      # Database connection failure
      - alert: DatabaseDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL database is down"
          description: "Cannot connect to PostgreSQL database"

      # Redis connection failure
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis is down"
          description: "Cannot connect to Redis cache/queue"

      # No Celery workers
      - alert: NoCeleryWorkers
        expr: celery_workers == 0
        for: 5m
        labels:
          severity: critical
          component: celery
        annotations:
          summary: "No Celery workers available"
          description: "No Celery workers are active. Background jobs will not be processed."

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/",fstype!="tmpfs"}
            /
            node_filesystem_size_bytes{mountpoint="/",fstype!="tmpfs"}
          ) < 0.10
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Disk space critically low"
          description: "Disk space is below 10% on {{ $labels.instance }}. Available: {{ $value | humanizePercentage }}"

      # Memory critical
      - alert: MemoryCritical
        expr: |
          (
            node_memory_MemAvailable_bytes
            /
            node_memory_MemTotal_bytes
          ) < 0.10
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Memory critically low"
          description: "Available memory is below 10% on {{ $labels.instance }}. Available: {{ $value | humanizePercentage }}"

      # SSL certificate expiring soon
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: critical
          component: security
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"

  # ============================================================================
  # WARNING ALERTS - Should be investigated
  # ============================================================================

  - name: warning_alerts
    interval: 1m
    rules:
      # Slow API responses
      - alert: SlowAPIResponses
        expr: |
          histogram_quantile(0.95,
            sum(rate(civicq_http_request_duration_seconds_bucket[5m])) by (le, endpoint)
          ) > 2
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "Slow API responses detected"
          description: "95th percentile response time is {{ $value }}s for endpoint {{ $labels.endpoint }} (threshold: 2s)"

      # High database query time
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(civicq_database_query_duration_seconds_bucket[5m])) by (le, query_type)
          ) > 1
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}s for {{ $labels.query_type }} queries (threshold: 1s)"

      # Celery queue backup
      - alert: CeleryQueueBackup
        expr: celery_queue_length > 100
        for: 15m
        labels:
          severity: warning
          component: celery
        annotations:
          summary: "Celery queue backing up"
          description: "Celery queue {{ $labels.queue_name }} has {{ $value }} pending tasks"

      # Failed Celery tasks
      - alert: HighCeleryFailureRate
        expr: |
          (
            sum(rate(civicq_celery_tasks_total{status="failure"}[10m])) by (task_name)
            /
            sum(rate(civicq_celery_tasks_total[10m])) by (task_name)
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          component: celery
        annotations:
          summary: "High Celery task failure rate"
          description: "Task {{ $labels.task_name }} has a {{ $value | humanizePercentage }} failure rate (threshold: 10%)"

      # Video processing failures
      - alert: VideoProcessingFailures
        expr: rate(civicq_video_processing_errors_total[10m]) > 0.1
        for: 10m
        labels:
          severity: warning
          component: video
        annotations:
          summary: "Video processing failures detected"
          description: "Video processing is failing at {{ $value }} errors/second"

      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 15m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }} (threshold: 80%)"

      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          (
            (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
            /
            node_memory_MemTotal_bytes
          ) > 0.85
        for: 15m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }} (threshold: 85%)"

      # Disk space warning
      - alert: DiskSpaceWarning
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/",fstype!="tmpfs"}
            /
            node_filesystem_size_bytes{mountpoint="/",fstype!="tmpfs"}
          ) < 0.20
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Disk space running low"
          description: "Disk space is below 20% on {{ $labels.instance }}. Available: {{ $value | humanizePercentage }}"

      # Redis memory usage high
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.90
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis memory usage high"
          description: "Redis is using {{ $value | humanizePercentage }} of available memory (threshold: 90%)"

      # Database connections high
      - alert: DatabaseConnectionsHigh
        expr: |
          (
            sum(pg_stat_activity_count) by (instance)
            /
            pg_settings_max_connections
          ) > 0.80
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool usage high"
          description: "Database is using {{ $value | humanizePercentage }} of available connections (threshold: 80%)"

      # External API slow
      - alert: ExternalAPIsSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(civicq_external_api_duration_seconds_bucket[5m])) by (le, api_name)
          ) > 5
        for: 15m
        labels:
          severity: warning
          component: external_api
        annotations:
          summary: "External API responding slowly"
          description: "95th percentile response time for {{ $labels.api_name }} is {{ $value }}s (threshold: 5s)"

      # External API errors
      - alert: ExternalAPIErrors
        expr: |
          (
            sum(rate(civicq_external_api_requests_total{status="error"}[10m])) by (api_name)
            /
            sum(rate(civicq_external_api_requests_total[10m])) by (api_name)
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          component: external_api
        annotations:
          summary: "High error rate from external API"
          description: "{{ $labels.api_name }} has {{ $value | humanizePercentage }} error rate (threshold: 10%)"

  # ============================================================================
  # BUSINESS METRICS ALERTS
  # ============================================================================

  - name: business_alerts
    interval: 5m
    rules:
      # Sudden drop in user activity
      - alert: UserActivityDrop
        expr: |
          (
            sum(rate(civicq_user_logins_total[1h]))
            /
            sum(rate(civicq_user_logins_total[1h] offset 24h))
          ) < 0.5
        for: 30m
        labels:
          severity: warning
          component: business
        annotations:
          summary: "User activity dropped significantly"
          description: "User logins are {{ $value | humanizePercentage }} of normal levels"

      # High question rejection rate
      - alert: HighQuestionRejectionRate
        expr: |
          (
            sum(rate(civicq_questions_rejected_total[1h])) by (city_id)
            /
            sum(rate(civicq_questions_submitted_total[1h])) by (city_id)
          ) > 0.50
        for: 1h
        labels:
          severity: warning
          component: moderation
        annotations:
          summary: "High question rejection rate"
          description: "{{ $value | humanizePercentage }} of questions are being rejected for city {{ $labels.city_id }}"

      # Moderation queue backing up
      - alert: ModerationQueueBackup
        expr: civicq_questions_pending > 50
        for: 2h
        labels:
          severity: warning
          component: moderation
        annotations:
          summary: "Moderation queue backing up"
          description: "{{ $value }} questions pending moderation for city {{ $labels.city_id }}"
